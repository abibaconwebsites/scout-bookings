<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Manage your scout hut details - Scout Bookings">
  <title>Manage Your Hut - Scout Bookings</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    .page-hero {
      background-color: var(--color-white);
      border-bottom: 1px solid var(--color-border);
      padding: var(--space-xl) 0;
    }

    .page-hero .back-button {
      margin-bottom: var(--space-md);
    }

    .page-hero h1 {
      font-size: 1.75rem;
      margin-bottom: var(--space-xs);
    }

    .page-hero p {
      color: var(--color-placeholder);
      margin: 0;
    }

    .edit-hut-page {
      padding: var(--space-xl) 0 var(--space-3xl);
    }

    .form-card {
      background-color: var(--color-white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: var(--space-xl);
      margin-bottom: var(--space-lg);
    }

    .form-section {
      margin-bottom: var(--space-xl);
    }

    .form-section:last-child {
      margin-bottom: 0;
    }

    .form-section-title {
      font-size: 1.125rem;
      font-weight: 700;
      margin-bottom: var(--space-md);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .form-section-title .icon {
      font-size: 1.25rem;
    }

    .form-section-description {
      color: var(--color-placeholder);
      font-size: 0.875rem;
      margin-bottom: var(--space-lg);
    }

    /* Availability Schedule Styles */
    .availability-schedule {
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .day-row {
      display: grid;
      grid-template-columns: 120px 1fr auto auto;
      align-items: center;
      padding: var(--space-md);
      border-bottom: 1px solid var(--color-border);
      gap: var(--space-md);
    }

    .day-row:last-child {
      border-bottom: none;
    }

    .day-row.disabled {
      background-color: var(--color-background);
    }

    .day-row.disabled .day-times {
      opacity: 0.5;
      pointer-events: none;
    }

    .day-toggle {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .day-toggle input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--color-primary);
      cursor: pointer;
    }

    .day-name {
      font-weight: 600;
      min-width: 80px;
    }

    .day-times {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .time-input {
      width: 90px;
      padding: 0.375rem;
      font-size: 0.8125rem;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      background-color: var(--color-white);
      text-align: center;
      color: var(--color-text);
    }

    .time-input:focus {
      outline: none;
      border-color: var(--color-text);
    }

    .time-input::-webkit-calendar-picker-indicator {
      filter: grayscale(100%);
      opacity: 0.6;
      cursor: pointer;
    }

    .time-separator {
      color: var(--color-placeholder);
      font-weight: 500;
    }

    .copy-times-btn {
      font-size: 0.75rem;
      padding: 0.375rem 0.75rem;
      background-color: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      color: var(--color-text);
      cursor: pointer;
      transition: all var(--transition-fast);
      white-space: nowrap;
    }

    .copy-times-btn:hover {
      background-color: var(--color-border);
    }

    /* Slug Input */
    .slug-input-wrapper {
      display: flex;
      align-items: center;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background-color: var(--color-background);
      overflow: hidden;
    }

    .slug-prefix {
      padding: 0.625rem 0 0.625rem 0.75rem;
      color: var(--color-placeholder);
      font-size: 0.875rem;
      white-space: nowrap;
      background-color: var(--color-background);
    }

    .slug-input {
      border: none !important;
      background-color: var(--color-white) !important;
      border-radius: 0 var(--radius-md) var(--radius-md) 0 !important;
      flex: 1;
    }

    .slug-input:focus {
      box-shadow: none !important;
    }

    .slug-input-wrapper:focus-within {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(116, 19, 220, 0.1);
    }

    .slug-status {
      font-size: 0.8125rem;
      margin-top: var(--space-xs);
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }

    .slug-status.available {
      color: var(--color-success);
    }

    .slug-status.unavailable {
      color: var(--color-error);
    }

    .slug-status.checking {
      color: var(--color-placeholder);
    }

    /* Form Actions */
    .form-actions {
      display: flex;
      gap: var(--space-md);
      justify-content: flex-end;
      padding-top: var(--space-lg);
      border-top: 1px solid var(--color-border);
      margin-top: var(--space-xl);
    }

    /* Address Fields */
    .address-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-md);
    }

    .address-grid .form-group.full-width {
      grid-column: 1 / -1;
    }

    /* Group Sessions */
    .group-sessions {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }

    .group-session {
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      transition: all var(--transition-fast);
    }

    .group-session.disabled {
      background-color: var(--color-background);
    }

    .group-session.disabled .group-schedule {
      opacity: 0.5;
      pointer-events: none;
    }

    .group-row {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }

    .group-toggle {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      min-width: 120px;
    }

    .group-toggle input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--color-primary);
      cursor: pointer;
    }

    .group-name {
      font-weight: 600;
      font-size: 0.9375rem;
      cursor: pointer;
    }

    .group-schedule {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      flex: 1;
      justify-content: flex-end;
    }

    .group-day-select .form-label,
    .group-times .form-label {
      display: none;
    }

    .group-day-select .form-label,
    .group-times .form-label {
      margin-bottom: var(--space-xs);
    }

    .group-day-select .form-select {
      width: 140px;
      height: 38px;
      padding: 0.375rem 2rem 0.375rem 0.5rem;
      font-size: 0.8125rem;
      background-color: var(--color-white);
      color: var(--color-text);
      border: 1px solid var(--color-border) !important;
      border-radius: var(--radius-sm);
      line-height: 1.4;
    }

    .group-day-select .form-select:focus {
      outline: none;
      border-color: var(--color-text) !important;
      box-shadow: none !important;
    }

    .group-time-inputs {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .group-time-inputs .time-input {
      width: 90px;
      height: 38px;
      padding: 0.375rem;
      font-size: 0.8125rem;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      background-color: var(--color-white);
      color: var(--color-text);
      text-align: center;
    }

    .group-time-inputs .time-input:focus {
      outline: none;
      border-color: var(--color-text);
    }

    .group-time-inputs .time-input::-webkit-calendar-picker-indicator {
      filter: grayscale(100%);
      opacity: 0.6;
      cursor: pointer;
    }

    /* Loading State */
    .loading-state {
      text-align: center;
      padding: var(--space-3xl);
      color: var(--color-placeholder);
    }

    .loading-state .loading-spinner {
      margin: 0 auto var(--space-md);
    }

    @media (max-width: 768px) {
      .page-hero {
        padding: var(--space-lg) 0;
      }

      .page-hero h1 {
        font-size: 1.5rem;
      }

      .page-hero p {
        font-size: 0.875rem;
      }

      .edit-hut-page {
        padding: var(--space-lg) 0 var(--space-2xl);
      }

      .day-row {
        display: grid;
        grid-template-columns: 1fr auto;
        grid-template-rows: auto auto;
        gap: 0.5rem;
      }

      .day-toggle {
        grid-column: 1;
        grid-row: 1;
      }

      .copy-times-btn {
        grid-column: 2;
        grid-row: 1;
      }

      .day-times {
        grid-column: 1 / -1;
        grid-row: 2;
        justify-content: flex-start;
        padding-top: 0.5rem;
        border-top: 1px solid var(--color-border);
      }

      .group-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .group-schedule {
        width: 100%;
        flex-direction: row;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: nowrap;
      }

      .group-day-select .form-select {
        width: auto;
        min-width: 100px;
        flex-shrink: 0;
      }

      .group-time-inputs {
        flex: 1;
        justify-content: flex-end;
      }

      .group-time-inputs .time-input {
        width: 75px;
      }

      .address-grid {
        grid-template-columns: 1fr;
      }

      .form-actions {
        flex-direction: column;
      }

      .form-actions .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar" role="navigation" aria-label="Main navigation">
    <div class="nav-container">
      <a href="dashboard.html" class="logo" aria-label="Scout Bookings Dashboard">Scout Bookings</a>
      <div class="nav-actions">
        <a href="settings.html" class="nav-icon-btn" aria-label="Settings">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
          </svg>
        </a>
        <button onclick="handleLogout()" class="nav-icon-btn" aria-label="Logout">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 9V5.25A2.25 2.25 0 0 1 10.5 3h6a2.25 2.25 0 0 1 2.25 2.25v13.5A2.25 2.25 0 0 1 16.5 21h-6a2.25 2.25 0 0 1-2.25-2.25V15m-3 0-3-3m0 0 3-3m-3 3H15" />
          </svg>
        </button>
      </div>
    </div>
  </nav>

  <!-- Page Hero -->
  <section class="page-hero">
    <div class="container container-md">
      <a href="dashboard.html" class="back-button">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Back to Dashboard
      </a>
      <h1 id="page-title">Edit Your Scout Hut</h1>
      <p id="page-subtitle">Update your hut details and availability schedule</p>
    </div>
  </section>

  <!-- Main Content -->
  <main class="container container-md edit-hut-page">
    <!-- Loading State -->
    <div id="loading-state" class="loading-state">
      <div class="loading-spinner"></div>
      <p>Loading hut details...</p>
    </div>

    <!-- Edit Hut Form -->
    <form id="edit-hut-form" style="display: none;">
      <!-- Basic Details Section -->
      <div class="form-card">
        <div class="form-section">
          <h2 class="form-section-title">
            Basic Details
          </h2>
          <p class="form-section-description">Update your scout hut's name</p>
          
          <div class="form-group">
            <label for="hut-name" class="form-label required">Group Name</label>
            <input 
              type="text" 
              id="hut-name" 
              name="name" 
              class="form-input" 
              placeholder="e.g. 1st Anytown Scout Group"
              required
              maxlength="100"
            >
            <span class="form-hint">This is how your group will appear to people making bookings</span>
          </div>

          <div class="form-group">
            <label for="hut-slug" class="form-label">Booking Link</label>
            <div class="slug-input-wrapper">
              <span class="slug-prefix">scoutbookings.com/book/</span>
              <input 
                type="text" 
                id="hut-slug" 
                name="slug" 
                class="form-input slug-input" 
                placeholder="my-scout-hut"
                maxlength="100"
                pattern="[a-z0-9-]+"
              >
            </div>
            <span class="form-hint">Your public booking page URL. Use lowercase letters, numbers, and hyphens only.</span>
            <div id="slug-status" class="slug-status"></div>
            <button type="button" id="copy-url-btn" class="btn btn-secondary btn-small" style="margin-top: var(--space-sm); display: none;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
              Copy Link
            </button>
          </div>

        </div>

        <!-- Address Section -->
        <div class="form-section">
          <h2 class="form-section-title">
            Address
          </h2>
          <p class="form-section-description">Where is your scout hut located?</p>
          
          <div class="address-grid">
            <div class="form-group full-width">
              <label for="address-line1" class="form-label required">Address Line 1</label>
              <input 
                type="text" 
                id="address-line1" 
                name="address_line1" 
                class="form-input" 
                placeholder="Street address"
                required
                maxlength="200"
              >
            </div>
            
            <div class="form-group full-width">
              <label for="address-line2" class="form-label">Address Line 2</label>
              <input 
                type="text" 
                id="address-line2" 
                name="address_line2" 
                class="form-input" 
                placeholder="Apartment, suite, unit, etc. (optional)"
                maxlength="200"
              >
            </div>
            
            <div class="form-group">
              <label for="city" class="form-label required">City / Town</label>
              <input 
                type="text" 
                id="city" 
                name="city" 
                class="form-input" 
                placeholder="City or town"
                required
                maxlength="100"
              >
            </div>
            
            <div class="form-group">
              <label for="postcode" class="form-label required">Postcode</label>
              <input 
                type="text" 
                id="postcode" 
                name="postcode" 
                class="form-input" 
                placeholder="e.g. AB1 2CD"
                required
                maxlength="10"
              >
            </div>
          </div>
        </div>
      </div>

      <!-- Availability Section -->
      <div class="form-card">
        <div class="form-section">
          <h2 class="form-section-title">
            Availability Schedule
          </h2>
          <p class="form-section-description">Set the days and hours when your hut is available for bookings.</p>

          <!-- Availability Schedule -->
          <div class="availability-schedule" id="availability-schedule">
            <!-- Monday -->
            <div class="day-row" data-day="monday">
              <div class="day-toggle">
                <input type="checkbox" id="monday-enabled">
                <label for="monday-enabled" class="day-name">Monday</label>
              </div>
              <div class="day-times">
                <input type="time" class="time-input start-time" value="09:00" min="00:00" max="23:59" aria-label="Monday start time">
                <span class="time-separator">to</span>
                <input type="time" class="time-input end-time" value="21:00" min="00:00" max="23:59" aria-label="Monday end time">
              </div>
              <button type="button" class="copy-times-btn" onclick="copyTimesToAll('monday')">Copy to all</button>
            </div>

            <!-- Tuesday -->
            <div class="day-row" data-day="tuesday">
              <div class="day-toggle">
                <input type="checkbox" id="tuesday-enabled">
                <label for="tuesday-enabled" class="day-name">Tuesday</label>
              </div>
              <div class="day-times">
                <input type="time" class="time-input start-time" value="09:00" min="00:00" max="23:59" aria-label="Tuesday start time">
                <span class="time-separator">to</span>
                <input type="time" class="time-input end-time" value="21:00" min="00:00" max="23:59" aria-label="Tuesday end time">
              </div>
              <button type="button" class="copy-times-btn" onclick="copyTimesToAll('tuesday')">Copy to all</button>
            </div>

            <!-- Wednesday -->
            <div class="day-row" data-day="wednesday">
              <div class="day-toggle">
                <input type="checkbox" id="wednesday-enabled">
                <label for="wednesday-enabled" class="day-name">Wednesday</label>
              </div>
              <div class="day-times">
                <input type="time" class="time-input start-time" value="09:00" min="00:00" max="23:59" aria-label="Wednesday start time">
                <span class="time-separator">to</span>
                <input type="time" class="time-input end-time" value="21:00" min="00:00" max="23:59" aria-label="Wednesday end time">
              </div>
              <button type="button" class="copy-times-btn" onclick="copyTimesToAll('wednesday')">Copy to all</button>
            </div>

            <!-- Thursday -->
            <div class="day-row" data-day="thursday">
              <div class="day-toggle">
                <input type="checkbox" id="thursday-enabled">
                <label for="thursday-enabled" class="day-name">Thursday</label>
              </div>
              <div class="day-times">
                <input type="time" class="time-input start-time" value="09:00" min="00:00" max="23:59" aria-label="Thursday start time">
                <span class="time-separator">to</span>
                <input type="time" class="time-input end-time" value="21:00" min="00:00" max="23:59" aria-label="Thursday end time">
              </div>
              <button type="button" class="copy-times-btn" onclick="copyTimesToAll('thursday')">Copy to all</button>
            </div>

            <!-- Friday -->
            <div class="day-row" data-day="friday">
              <div class="day-toggle">
                <input type="checkbox" id="friday-enabled">
                <label for="friday-enabled" class="day-name">Friday</label>
              </div>
              <div class="day-times">
                <input type="time" class="time-input start-time" value="09:00" min="00:00" max="23:59" aria-label="Friday start time">
                <span class="time-separator">to</span>
                <input type="time" class="time-input end-time" value="21:00" min="00:00" max="23:59" aria-label="Friday end time">
              </div>
              <button type="button" class="copy-times-btn" onclick="copyTimesToAll('friday')">Copy to all</button>
            </div>

            <!-- Saturday -->
            <div class="day-row" data-day="saturday">
              <div class="day-toggle">
                <input type="checkbox" id="saturday-enabled">
                <label for="saturday-enabled" class="day-name">Saturday</label>
              </div>
              <div class="day-times">
                <input type="time" class="time-input start-time" value="09:00" min="00:00" max="23:59" aria-label="Saturday start time">
                <span class="time-separator">to</span>
                <input type="time" class="time-input end-time" value="21:00" min="00:00" max="23:59" aria-label="Saturday end time">
              </div>
              <button type="button" class="copy-times-btn" onclick="copyTimesToAll('saturday')">Copy to all</button>
            </div>

            <!-- Sunday -->
            <div class="day-row" data-day="sunday">
              <div class="day-toggle">
                <input type="checkbox" id="sunday-enabled">
                <label for="sunday-enabled" class="day-name">Sunday</label>
              </div>
              <div class="day-times">
                <input type="time" class="time-input start-time" value="09:00" min="00:00" max="23:59" aria-label="Sunday start time">
                <span class="time-separator">to</span>
                <input type="time" class="time-input end-time" value="21:00" min="00:00" max="23:59" aria-label="Sunday end time">
              </div>
              <button type="button" class="copy-times-btn" onclick="copyTimesToAll('sunday')">Copy to all</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Weekly Group Sessions -->
      <div class="form-card">
        <div class="form-section">
          <h2 class="form-section-title">
            Weekly Group Sessions
          </h2>
          <p class="form-section-description">Set regular weekly times for your scout groups. These will be blocked out on the calendar but won't appear as individual bookings.</p>
          
          <div class="group-sessions">
            <!-- Squirrels -->
            <div class="group-session" data-group="squirrels">
              <div class="group-row">
                <div class="group-toggle">
                  <input type="checkbox" id="squirrels-enabled">
                  <label for="squirrels-enabled" class="group-name">Squirrels</label>
                </div>
                <div class="group-schedule" id="squirrels-schedule">
                  <div class="group-day-select">
                    <select class="form-select group-day" id="squirrels-day">
                      <option value="">Select day...</option>
                      <option value="monday">Monday</option>
                      <option value="tuesday">Tuesday</option>
                      <option value="wednesday">Wednesday</option>
                      <option value="thursday">Thursday</option>
                      <option value="friday">Friday</option>
                      <option value="saturday">Saturday</option>
                      <option value="sunday">Sunday</option>
                    </select>
                  </div>
                  <div class="group-times">
                    <div class="group-time-inputs">
                      <input type="time" class="time-input" id="squirrels-start" value="16:00" min="00:00" max="23:59">
                      <span class="time-separator">to</span>
                      <input type="time" class="time-input" id="squirrels-end" value="17:00" min="00:00" max="23:59">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Beavers -->
            <div class="group-session" data-group="beavers">
              <div class="group-row">
                <div class="group-toggle">
                  <input type="checkbox" id="beavers-enabled">
                  <label for="beavers-enabled" class="group-name">Beavers</label>
                </div>
                <div class="group-schedule" id="beavers-schedule">
                  <div class="group-day-select">
                    <select class="form-select group-day" id="beavers-day">
                      <option value="">Select day...</option>
                      <option value="monday">Monday</option>
                      <option value="tuesday">Tuesday</option>
                      <option value="wednesday">Wednesday</option>
                      <option value="thursday">Thursday</option>
                      <option value="friday">Friday</option>
                      <option value="saturday">Saturday</option>
                      <option value="sunday">Sunday</option>
                    </select>
                  </div>
                  <div class="group-times">
                    <div class="group-time-inputs">
                      <input type="time" class="time-input" id="beavers-start" value="17:30" min="00:00" max="23:59">
                      <span class="time-separator">to</span>
                      <input type="time" class="time-input" id="beavers-end" value="18:30" min="00:00" max="23:59">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Cubs -->
            <div class="group-session" data-group="cubs">
              <div class="group-row">
                <div class="group-toggle">
                  <input type="checkbox" id="cubs-enabled">
                  <label for="cubs-enabled" class="group-name">Cubs</label>
                </div>
                <div class="group-schedule" id="cubs-schedule">
                  <div class="group-day-select">
                    <select class="form-select group-day" id="cubs-day">
                      <option value="">Select day...</option>
                      <option value="monday">Monday</option>
                      <option value="tuesday">Tuesday</option>
                      <option value="wednesday">Wednesday</option>
                      <option value="thursday">Thursday</option>
                      <option value="friday">Friday</option>
                      <option value="saturday">Saturday</option>
                      <option value="sunday">Sunday</option>
                    </select>
                  </div>
                  <div class="group-times">
                    <div class="group-time-inputs">
                      <input type="time" class="time-input" id="cubs-start" value="18:30" min="00:00" max="23:59">
                      <span class="time-separator">to</span>
                      <input type="time" class="time-input" id="cubs-end" value="20:00" min="00:00" max="23:59">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Scouts -->
            <div class="group-session" data-group="scouts">
              <div class="group-row">
                <div class="group-toggle">
                  <input type="checkbox" id="scouts-enabled">
                  <label for="scouts-enabled" class="group-name">Scouts</label>
                </div>
                <div class="group-schedule" id="scouts-schedule">
                  <div class="group-day-select">
                    <select class="form-select group-day" id="scouts-day">
                      <option value="">Select day...</option>
                      <option value="monday">Monday</option>
                      <option value="tuesday">Tuesday</option>
                      <option value="wednesday">Wednesday</option>
                      <option value="thursday">Thursday</option>
                      <option value="friday">Friday</option>
                      <option value="saturday">Saturday</option>
                      <option value="sunday">Sunday</option>
                    </select>
                  </div>
                  <div class="group-times">
                    <div class="group-time-inputs">
                      <input type="time" class="time-input" id="scouts-start" value="19:00" min="00:00" max="23:59">
                      <span class="time-separator">to</span>
                      <input type="time" class="time-input" id="scouts-end" value="21:00" min="00:00" max="23:59">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <a href="dashboard.html" class="btn btn-secondary">Cancel</a>
          <button type="submit" class="btn btn-primary" id="submit-btn">Save Changes</button>
        </div>
      </div>
    </form>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <p class="text-center text-muted">&copy; 2026 Scout Bookings. All rights reserved.</p>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../js/config.js"></script>
  <script src="../js/utils.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/huts.js"></script>
  <script>
    // =============================================================================
    // PAGE INITIALIZATION
    // =============================================================================

    let currentUser = null;
    let currentHut = null;
    let isCreateMode = false; // Track if we're creating or editing

    document.addEventListener('DOMContentLoaded', async function() {
      // Check if user is authenticated
      currentUser = await checkAuth();
      
      if (!currentUser) {
        return; // checkAuth will redirect to login
      }

      // Load user's hut
      currentHut = await getUserHut(currentUser.id);
      
      if (!currentHut) {
        // No hut exists - switch to create mode
        isCreateMode = true;
        setupCreateMode();
      } else {
        // Hut exists - edit mode
        isCreateMode = false;
        populateForm(currentHut);
      }

      // Set up day toggle listeners
      setupDayToggles();

      // Set up group session toggles
      setupGroupToggles();

      // Set up slug input
      setupSlugInput();

      // Set up form submission
      document.getElementById('edit-hut-form').addEventListener('submit', handleFormSubmit);

      // Hide loading, show form
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('edit-hut-form').style.display = 'block';
    });

    /**
     * Sets up the page for create mode (new hut)
     */
    function setupCreateMode() {
      // Update page title and subtitle
      document.getElementById('page-title').textContent = 'Set Up Your Scout Hut';
      document.getElementById('page-subtitle').textContent = 'Enter your hut details and set when it\'s available for bookings';
      document.title = 'Set Up Your Hut - Scout Bookings';
      
      // Update submit button text
      document.getElementById('submit-btn').textContent = 'Create Scout Hut';
      
      // Enable all days by default for new huts
      const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
      days.forEach(day => {
        const checkbox = document.getElementById(`${day}-enabled`);
        if (checkbox) checkbox.checked = true;
      });
      
      // Disable all group sessions by default
      const groups = ['squirrels', 'beavers', 'cubs', 'scouts'];
      groups.forEach(group => {
        const session = document.querySelector(`[data-group="${group}"]`);
        if (session) session.classList.add('disabled');
      });
    }

    // =============================================================================
    // POPULATE FORM WITH EXISTING DATA
    // =============================================================================

    /**
     * Populates the form fields with existing hut data
     * @param {Object} hut - The hut object from the database
     */
    function populateForm(hut) {
      // Basic details
      document.getElementById('hut-name').value = hut.name || '';
      
      // Slug / Booking Link
      const slugInput = document.getElementById('hut-slug');
      const copyUrlBtn = document.getElementById('copy-url-btn');
      if (hut.slug) {
        slugInput.value = hut.slug;
        copyUrlBtn.style.display = 'inline-flex';
        updateSlugStatus('available', 'This is your current booking link');
      }
      
      // Address
      document.getElementById('address-line1').value = hut.address_line1 || '';
      document.getElementById('address-line2').value = hut.address_line2 || '';
      document.getElementById('city').value = hut.city || '';
      document.getElementById('postcode').value = hut.postcode || '';

      // Availability
      if (hut.availability) {
        const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        
        days.forEach(day => {
          const dayConfig = hut.availability[day];
          const checkbox = document.getElementById(`${day}-enabled`);
          const row = document.querySelector(`[data-day="${day}"]`);
          
          if (dayConfig && checkbox && row) {
            checkbox.checked = dayConfig.enabled;
            row.querySelector('.start-time').value = dayConfig.start_time || '09:00';
            row.querySelector('.end-time').value = dayConfig.end_time || '21:00';
            
            if (!dayConfig.enabled) {
              row.classList.add('disabled');
            }
          }
        });
      }

      // Weekly group sessions
      if (hut.weekly_sessions) {
        const groups = ['squirrels', 'beavers', 'cubs', 'scouts'];
        
        groups.forEach(group => {
          const groupConfig = hut.weekly_sessions[group];
          const checkbox = document.getElementById(`${group}-enabled`);
          const session = document.querySelector(`[data-group="${group}"]`);
          
          if (groupConfig && checkbox && session) {
            checkbox.checked = groupConfig.enabled;
            document.getElementById(`${group}-day`).value = groupConfig.day || '';
            document.getElementById(`${group}-start`).value = groupConfig.start_time || '';
            document.getElementById(`${group}-end`).value = groupConfig.end_time || '';
            
            if (!groupConfig.enabled) {
              session.classList.add('disabled');
            }
          } else if (session) {
            session.classList.add('disabled');
          }
        });
      } else {
        // Default all to disabled
        const groups = ['squirrels', 'beavers', 'cubs', 'scouts'];
        groups.forEach(group => {
          const session = document.querySelector(`[data-group="${group}"]`);
          if (session) session.classList.add('disabled');
        });
      }
    }

    // =============================================================================
    // DAY TOGGLE FUNCTIONALITY
    // =============================================================================

    /**
     * Sets up event listeners for day enable/disable checkboxes
     */
    function setupDayToggles() {
      const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
      
      days.forEach(day => {
        const checkbox = document.getElementById(`${day}-enabled`);
        const row = document.querySelector(`[data-day="${day}"]`);
        
        if (checkbox && row) {
          checkbox.addEventListener('change', function() {
            if (this.checked) {
              row.classList.remove('disabled');
            } else {
              row.classList.add('disabled');
            }
          });
        }
      });
    }

    /**
     * Sets up event listeners for group session enable/disable checkboxes
     */
    function setupGroupToggles() {
      const groups = ['squirrels', 'beavers', 'cubs', 'scouts'];
      
      groups.forEach(group => {
        const checkbox = document.getElementById(`${group}-enabled`);
        const session = document.querySelector(`[data-group="${group}"]`);
        
        if (checkbox && session) {
          checkbox.addEventListener('change', function() {
            if (this.checked) {
              session.classList.remove('disabled');
            } else {
              session.classList.add('disabled');
            }
          });
        }

      });
    }

    /**
     * Copies times from one day to all other days
     * @param {string} sourceDay - The day to copy times from
     */
    function copyTimesToAll(sourceDay) {
      const sourceRow = document.querySelector(`[data-day="${sourceDay}"]`);
      if (!sourceRow) return;

      const sourceStart = sourceRow.querySelector('.start-time').value;
      const sourceEnd = sourceRow.querySelector('.end-time').value;

      const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
      
      days.forEach(day => {
        const row = document.querySelector(`[data-day="${day}"]`);
        if (row) {
          row.querySelector('.start-time').value = sourceStart;
          row.querySelector('.end-time').value = sourceEnd;
        }
      });

      showNotification('Times copied to all days', 'success');
    }

    // =============================================================================
    // SLUG / BOOKING LINK FUNCTIONALITY
    // =============================================================================

    let slugCheckTimeout = null;
    let currentSlugValid = true;

    /**
     * Sets up the slug input event listeners
     */
    function setupSlugInput() {
      const slugInput = document.getElementById('hut-slug');
      const copyUrlBtn = document.getElementById('copy-url-btn');
      const hutNameInput = document.getElementById('hut-name');

      // Validate and check slug on input
      slugInput.addEventListener('input', function() {
        // Normalize input: lowercase, replace spaces with hyphens, remove invalid chars
        let value = this.value.toLowerCase()
          .replace(/\s+/g, '-')
          .replace(/[^a-z0-9-]/g, '');
        this.value = value;

        // Debounce the availability check
        clearTimeout(slugCheckTimeout);
        
        if (value.length === 0) {
          updateSlugStatus('', '');
          copyUrlBtn.style.display = 'none';
          currentSlugValid = true;
          return;
        }

        if (value.length < 3) {
          updateSlugStatus('unavailable', 'Slug must be at least 3 characters');
          copyUrlBtn.style.display = 'none';
          currentSlugValid = false;
          return;
        }

        updateSlugStatus('checking', 'Checking availability...');
        
        slugCheckTimeout = setTimeout(async () => {
          await checkSlugAndUpdate(value);
        }, 500);
      });

      // Copy URL button
      copyUrlBtn.addEventListener('click', function() {
        const slug = slugInput.value;
        if (slug) {
          const url = `https://scoutbookings.co.uk/book/${slug}`;
          navigator.clipboard.writeText(url).then(() => {
            showNotification('Booking link copied to clipboard!', 'success');
          }).catch(() => {
            showNotification('Failed to copy link', 'error');
          });
        }
      });

      // Auto-generate slug from name if slug is empty when name changes
      hutNameInput.addEventListener('blur', function() {
        const slugInput = document.getElementById('hut-slug');
        if (!slugInput.value && this.value) {
          const generatedSlug = generateSlug(this.value);
          if (generatedSlug && generatedSlug.length >= 3) {
            slugInput.value = generatedSlug;
            slugInput.dispatchEvent(new Event('input'));
          }
        }
      });
    }

    /**
     * Checks slug availability and updates the UI
     * @param {string} slug - The slug to check
     */
    async function checkSlugAndUpdate(slug) {
      const copyUrlBtn = document.getElementById('copy-url-btn');
      
      try {
        // Exclude current hut's ID when checking (so editing doesn't fail on own slug)
        const excludeId = currentHut ? currentHut.id : null;
        const isAvailable = await checkSlugAvailability(slug, excludeId);
        
        if (isAvailable) {
          updateSlugStatus('available', 'This booking link is available');
          copyUrlBtn.style.display = 'inline-flex';
          currentSlugValid = true;
        } else {
          updateSlugStatus('unavailable', 'This booking link is already taken');
          copyUrlBtn.style.display = 'none';
          currentSlugValid = false;
        }
      } catch (err) {
        console.error('Error checking slug:', err);
        updateSlugStatus('unavailable', 'Error checking availability');
        currentSlugValid = false;
      }
    }

    /**
     * Updates the slug status display
     * @param {string} status - 'available', 'unavailable', 'checking', or ''
     * @param {string} message - The message to display
     */
    function updateSlugStatus(status, message) {
      const statusEl = document.getElementById('slug-status');
      statusEl.className = 'slug-status ' + status;
      
      if (!message) {
        statusEl.innerHTML = '';
        return;
      }

      let icon = '';
      if (status === 'available') {
        icon = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
      } else if (status === 'unavailable') {
        icon = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
      } else if (status === 'checking') {
        icon = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="spin"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>';
      }
      
      statusEl.innerHTML = icon + ' ' + message;
    }

    // =============================================================================
    // FORM SUBMISSION
    // =============================================================================

    /**
     * Collects availability data from the schedule UI
     * @returns {Object} Availability object with day keys
     */
    function collectAvailability() {
      const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
      const availability = {};

      days.forEach(day => {
        const checkbox = document.getElementById(`${day}-enabled`);
        const row = document.querySelector(`[data-day="${day}"]`);
        
        if (checkbox && row) {
          availability[day] = {
            enabled: checkbox.checked,
            start_time: row.querySelector('.start-time').value,
            end_time: row.querySelector('.end-time').value
          };
        }
      });

      return availability;
    }

    /**
     * Collects weekly group sessions data
     * @returns {Object} Weekly sessions object with group keys
     */
    function collectWeeklySessions() {
      const groups = ['squirrels', 'beavers', 'cubs', 'scouts'];
      const sessions = {};

      groups.forEach(group => {
        const checkbox = document.getElementById(`${group}-enabled`);
        
        if (checkbox) {
          sessions[group] = {
            enabled: checkbox.checked,
            day: document.getElementById(`${group}-day`).value,
            start_time: document.getElementById(`${group}-start`).value,
            end_time: document.getElementById(`${group}-end`).value
          };
        }
      });

      return sessions;
    }

    /**
     * Validates the weekly sessions
     * @param {Object} sessions - The sessions object to validate
     * @returns {Object} { valid: boolean, message: string }
     */
    function validateWeeklySessions(sessions) {
      const groupNames = {
        squirrels: 'Squirrels',
        beavers: 'Beavers',
        cubs: 'Cubs',
        scouts: 'Scouts'
      };

      for (const [group, config] of Object.entries(sessions)) {
        if (config.enabled) {
          if (!config.day) {
            return { 
              valid: false, 
              message: `${groupNames[group]}: Please select a day.` 
            };
          }
          if (!config.start_time || !config.end_time) {
            return { 
              valid: false, 
              message: `${groupNames[group]}: Please set start and end times.` 
            };
          }
          if (config.start_time >= config.end_time) {
            return { 
              valid: false, 
              message: `${groupNames[group]}: End time must be after start time.` 
            };
          }
        }
      }

      return { valid: true, message: '' };
    }

    /**
     * Validates the availability schedule
     * @param {Object} availability - The availability object to validate
     * @returns {Object} { valid: boolean, message: string }
     */
    function validateAvailability(availability) {
      // Check if at least one day is enabled
      const enabledDays = Object.values(availability).filter(day => day.enabled);
      if (enabledDays.length === 0) {
        return { valid: false, message: 'Please enable at least one day for availability.' };
      }

      // Check that end time is after start time for enabled days
      for (const [day, config] of Object.entries(availability)) {
        if (config.enabled) {
          if (config.start_time >= config.end_time) {
            return { 
              valid: false, 
              message: `${day.charAt(0).toUpperCase() + day.slice(1)}: End time must be after start time.` 
            };
          }
        }
      }

      return { valid: true, message: '' };
    }

    /**
     * Handles form submission
     * @param {Event} event - The form submit event
     */
    async function handleFormSubmit(event) {
      event.preventDefault();

      // Get form elements
      const submitBtn = document.getElementById('submit-btn');
      const originalBtnText = submitBtn.textContent;

      // Collect form data
      const name = document.getElementById('hut-name').value.trim();
      const slug = document.getElementById('hut-slug').value.trim();
      const addressLine1 = document.getElementById('address-line1').value.trim();
      const addressLine2 = document.getElementById('address-line2').value.trim();
      const city = document.getElementById('city').value.trim();
      const postcode = document.getElementById('postcode').value.trim().toUpperCase();

      // Validate required fields
      if (!name) {
        showNotification('Please enter a name for your scout hut.', 'error');
        document.getElementById('hut-name').focus();
        return;
      }

      if (!addressLine1 || !city || !postcode) {
        showNotification('Please fill in all required address fields.', 'error');
        return;
      }

      // Validate slug if provided
      if (slug && !currentSlugValid) {
        showNotification('Please choose an available booking link.', 'error');
        document.getElementById('hut-slug').focus();
        return;
      }

      // Collect and validate availability
      const availability = collectAvailability();
      const availabilityValidation = validateAvailability(availability);
      
      if (!availabilityValidation.valid) {
        showNotification(availabilityValidation.message, 'error');
        return;
      }

      // Collect and validate weekly sessions
      const weeklySessions = collectWeeklySessions();
      const sessionsValidation = validateWeeklySessions(weeklySessions);
      
      if (!sessionsValidation.valid) {
        showNotification(sessionsValidation.message, 'error');
        return;
      }

      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.textContent = isCreateMode ? 'Creating...' : 'Saving...';

      try {
        const hutData = {
          name,
          slug: slug || null,
          address_line1: addressLine1,
          address_line2: addressLine2 || null,
          city,
          postcode,
          availability,
          weekly_sessions: weeklySessions
        };

        let result;
        
        if (isCreateMode) {
          // Create new hut
          result = await createHut(currentUser.id, hutData);
          
          if (result.error) {
            throw new Error(result.error.message || 'Failed to create scout hut');
          }
          
          showNotification('Scout hut created successfully!', 'success');
        } else {
          // Update existing hut
          result = await updateHut(currentHut.id, currentUser.id, hutData);
          
          if (result.error) {
            throw new Error(result.error.message || 'Failed to update scout hut');
          }
          
          showNotification('Scout hut updated successfully!', 'success');
        }
        
        // Redirect to dashboard after a short delay
        setTimeout(() => {
          window.location.href = 'dashboard.html';
        }, 1500);

      } catch (err) {
        console.error('Error saving hut:', err);
        showNotification(err.message || 'Failed to save scout hut. Please try again.', 'error');
        
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.textContent = originalBtnText;
      }
    }
  </script>
</body>
</html>
